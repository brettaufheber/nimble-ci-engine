variables:
  NODE_ENV: "production"
  BASE_URL: "https://httpbin.org"
  AUTH_TOKEN: "mytoken123"
  MAX_CONCURRENT_PIPELINES: "6"
  MAX_CONCURRENT_JOBS: "2"

concurrency:
  max_parallel_pipelines:
    tpl: '$vars.MAX_CONCURRENT_PIPELINES | tonumber'
  max_parallel_jobs_per_pipeline:
    tpl: '$vars.MAX_CONCURRENT_JOBS | tonumber'

pipelines:
  - name: library
    needs: []
    workspace_dir: /opt/ci/workspaces/library
    repository:
      uri: https://github.com/jenkinsci/git-plugin.git
      ref: main
      fetch_depth: 1
      sparse_paths:
        - "src/"
        - "docs/README.md"
    variables:
      COVERAGE_ENABLED: "true"
      AUTH_TOKEN_2:
        src: file:///home/nosu/Documents/nas/home/Projekte/tiny-ci-engine/secret.txt
      HTTP1:
        src: '\(.BASE_URL)/headers'
        tpl: '. | fromjson | .headers["X-Authorization"]'
    jobs:
      - name: build
        variables:
          FOO: |-
              a
              b
        restrictions:
          timeout:
            duration: 5m
            termination_grace_period: 10s
          memory:
            limit: 1536M
            throttle_mark: 1024M
          cpu:
            limit: 0.5
          run_as:
            user: 1000
            group: cigroup
            supplementary_groups:
              - "docker"
              - "lxd"
              - "2001"
            allow_privilege_escalation: true
        steps:
          - git checkout HEAD
          - make build
      - name: lint
        steps:
          - make lint
      - name: test
        needs:
          - build
          - lint
        steps:
          - make test
      - name: notify-error
        needs:
          - build
          - lint
          - test
        steps:
          - echo '✘ Mindestens ein Job ist fehlgeschlagen'
      - name: notify-success
        needs:
          - build
          - lint
          - test
        condition: any_failed
        steps:
          - echo '✔ Alle Jobs erfolgreich durchgelaufen'

  - name: application1
    needs:
      - library
    workspace_dir: /opt/ci/workspaces/application1
    repository:
      uri: ssh://github.com/jenkinsci/git-plugin.git
      ref: develop
    variables:
      NODE_ENV: development
      CI_JOB_TIMEOUT: 5m
    jobs:
      - name: install
        steps:
          - npm ci
      - name: build
        needs:
          - install
        steps:
          - npm run build
      - name: test
        needs:
          - install
        steps:
          - npm test
      - name: lint
        needs:
          - install
        steps:
          - npm run lint

  - name: application2
    needs:
      - library
    workspace_dir: /opt/ci/workspaces/application2
    repository:
      uri: file:///srv/git/application.git
      ref: develop
    jobs:
      - name: install
        steps:
          - npm install --production
      - name: build
        needs:
          - install
        steps:
          - npm run build
      - name: test
        needs:
          - install
        steps:
          - npm test
